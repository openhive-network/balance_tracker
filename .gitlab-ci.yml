stages:
 - build
 - test

variables:
  # Variables required by Common CI jobs
  CI_COMMON_JOB_VERSION: "27bf7a315f3cacdf45336501112e6ac414d39006"
  DOCKER_BUILDER_TAG: "$CI_COMMON_JOB_VERSION"
  DOCKER_DIND_TAG: "$CI_COMMON_JOB_VERSION"
  IMAGE_REMOVER_TAG: "$CI_COMMON_JOB_VERSION"

include:
  - template: Workflows/Branch-Pipelines.gitlab-ci.yml
  - project: 'hive/common-ci-configuration'
    ref: 27bf7a315f3cacdf45336501112e6ac414d39006 # develop
    file: '/templates/docker_image_jobs.gitlab-ci.yml'

.docker-base-build-template:
  extends: .docker_image_builder_job_template
  stage: build
  variables:
    BASE_TAG: ubuntu-22.04-1
    NAME: ""
  before_script:
    - !reference [.docker_image_builder_job_template, before_script]
    - |
      echo -e "\e[0Ksection_start:$(date +%s):login[collapsed=true]\r\e[0KLogging to Docker registry..."
      docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
      echo -e "\e[0Ksection_end:$(date +%s):login\r\e[0K"
  script:
    - |
      echo -e "\e[0Ksection_end:$(date +%s):tag\r\e[0K"
      echo -e "\e[0Ksection_start:$(date +%s):build[collapsed=true]\r\e[0KBaking $NAME base image..."
      function image-exists() {
        local image=$1
        docker manifest inspect "$1" > /dev/null
        return $?
      }
      if image-exists "$CI_REGISTRY_IMAGE/$NAME/base:$BASE_TAG"; then
        echo "${NAME^} base already image exists. Skipping..."
      else
        echo "Baking $NAME base image..."
        git config --global --add safe.directory $(pwd)
        # Using --push instead of --load triggers a bug in GitLab UI
        docker buildx bake --progress=plain --load "$NAME-base"
        docker push --quiet "$CI_REGISTRY_IMAGE/$NAME/base:$BASE_TAG"
      fi
      echo -e "\e[0Ksection_end:$(date +%s):build\r\e[0K"
  tags:
    - public-runner-docker

docker-backend-base-build:
  extends: .docker-base-build-template
  variables:
    NAME: "backend"

docker-frontend-base-build:
  extends: .docker-base-build-template
  variables:
    NAME: "frontend"

docker-build:
  extends: .docker_image_builder_job_template
  stage: build
  needs:
   - docker-backend-base-build
   - docker-frontend-base-build
  before_script:
    - !reference [.docker_image_builder_job_template, before_script]
    - |
      echo -e "\e[0Ksection_start:$(date +%s):login[collapsed=true]\r\e[0KLogging to Docker registry..."
      docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
      echo -e "\e[0Ksection_end:$(date +%s):login\r\e[0K"
  script:
    - |
      echo -e "\e[0Ksection_start:$(date +%s):tag[collapsed=true]\r\e[0KDetermining tag for the new image..."
      if [[ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]]; then
        echo "Running on default branch '$CI_DEFAULT_BRANCH': tag = 'latest'"
        export TAG="latest"
      else
        echo "Running on branch '$CI_COMMIT_BRANCH': tag = $CI_COMMIT_REF_SLUG"
        export TAG="$CI_COMMIT_REF_SLUG"
      fi
      echo -e "\e[0Ksection_end:$(date +%s):tag\r\e[0K"
      echo -e "\e[0Ksection_start:$(date +%s):build[collapsed=true]\r\e[0KBaking frontend and backend images..."
      git config --global --add safe.directory $(pwd)
      # Using --push instead of --load triggers a bug in GitLab UI
      docker buildx bake --progress=plain --load ci
      docker push --quiet "$CI_REGISTRY_IMAGE/backend:$TAG"
      docker push --quiet "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA"
      [[ -n $CI_COMMIT_TAG ]] && docker push --quiet "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_TAG"
      docker push --quiet "$CI_REGISTRY_IMAGE/frontend:$TAG"
      docker push --quiet "$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA"
      [[ -n $CI_COMMIT_TAG ]] && docker push --quiet "$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_TAG"
      echo -e "\e[0Ksection_end:$(date +%s):build\r\e[0K"
  tags:
    - public-runner-docker